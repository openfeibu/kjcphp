<!DOCTYPE HTML>
<html>
    <head>
        <{include file="block/sheader.html"}>
        <script type="text/javascript" src="<{$pager.res}>/script/jquery.form.js"></script>
    </head>
    <body>
        <form action="<{link ctl='order/comment_handle' }>" mini-form="car-form" id="comment_form" method="post">
            <header>
                <i class="left"><a href="" class="gobackIco"></a></i>
                <div class="title">
                    <{L('评价商家')}>
                </div>
                <i class="right"><a class="searchIco" href="#"></a></i>
            </header>
            <section class="page_center_box">
                <script>
                    function fileSelected(obj, type) {
                        var files = obj.files;
                        for (var i = 0; i < files.length; i++) {
                            var tag = '';
                            var rFilter = /^(image\/gif|image\/jpeg|image\/jpg|image\/png)$/i;
                            if (!rFilter.test(files[i].type)) {
                                alert("<{L('只允许上传')}>JPG、PNG、GIF<{L('格式图片')}>");
                                return false;
                            }
                            var reader = new FileReader();
                            reader.onloadstart = function (e) {
                                $(".loading").show();
                            }
                            reader.onload = function (e) {
                                $('#photo' + type).hide();
                                $("#img" + type).attr("src", e.target.result).show();  //图片编码字符串
                            }
                            reader.readAsDataURL(files[i]);
                        }
                    }
                </script>
                <div class="shangjia mt10">
                    <div class="shangjia_attention mb10">
                        <div class="img fl"><img src="<{$pager.img}>/<{$shop.logo}>" width="100" height="100" /></div>
                        <div class="wz">
                            <div class="left">
                                <P><{$shop.title}></P>
                            </div>
                            <a href="javascript:void(0);" rel="<{$shop.collect}>" id="collect_btn" class="pub_btn"><{if $shop['collect'] ==0}><{L('收藏')}><{else}><{L('取消收藏')}><{/if}></a>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="nrBox mb10" style="border-top:0.01rem solid #dedede;">
                        <ul>
                            <li class="shangjia_hd_list score_fuwu"><p><{L('服务态度')}>&nbsp;&nbsp;<span class="starBg" style="position:relative;">
                                        <span class="star_clink"><a href="javascript:void(0);" val="1"></a><a href="javascript:void(0);" val="2"></a><a href="javascript:void(0);" val="3"></a><a href="javascript:void(0);" val="4"></a><a href="javascript:void(0);" val="5"></a>
                                        </span>
                                        <span class="star" style="width:60%;"></span>
                                        <input type='hidden' name="data[score_fuwu]" id="score_fuwu" value="3">
                                    </span></p>
                            </li>
                            <li class="shangjia_hd_list score_kouwei"><p><{L('菜品口味')}>&nbsp;&nbsp;<span class="starBg" style="position:relative;">

                                        <span class="star_clink"><a href="javascript:void(0);" val="1"></a><a href="javascript:void(0);" val="2"></a><a href="javascript:void(0);" val="3"></a><a href="javascript:void(0);" val="4"></a><a href="javascript:void(0);" val="5"></a>
                                        </span>

                                        <span class="star" style="width:60%;"></span>
                                        <input type='hidden' name="data[score_kouwei]" id="score_kouwei" value="3">
                                    </span></p>
                            </li>
                            <li class="shangjia_hd_list score"><p><{L('综合评分')}>&nbsp;&nbsp;<span class="starBg" style="position:relative;">

                                        <span class="star_clink"><a href="javascript:void(0);" val="1"></a><a href="javascript:void(0);" val="2"></a><a href="javascript:void(0);" val="3"></a><a href="javascript:void(0);" val="4"></a><a href="javascript:void(0);" val="5"></a>
                                        </span>
                                        <span class="star" style="width:60%;"></span>
                                        <input type='hidden' name="data[score]" id="score" value="3">
                                    </span></p>
                            </li>
                            <li class="shangjia_hd_list score_sudu"><p><{L('配送速度')}>&nbsp;&nbsp;
                                    <select name="data[pei_time]" size="1" id="pay_time" style="height:0.2rem;line-height:0.2rem;">
                                        <{foreach $peitime as $k => $v}>
                                        <option value="<{$k}>"><{$v}></option>
                                        <{/foreach}>
                                    </select>
                                </p>
                            </li>
                        </ul>
                        <div class="int_box_border" style="border-top:none 0;"><textarea name='data[content]' id="content" placeholder="<{L('说说您对本店的看法')}>，<{L('长度在')}>5-255<{L('字符之间')}>"></textarea></div>
                    </div>
                    <div class="shangjia_imgUpload">
                        <ul>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo1" id="photo1" onChange="fileSelected(this, 1)" value="<{L('上传')}>"   />
                                        <img src="" id="img1" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo2" id="photo2" onChange="fileSelected(this, 2)" value="<{L('上传')}>"   />
                                        <img src="" id="img2" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo3" id="photo3" onChange="fileSelected(this, 3)" value="<{L('上传')}>"   />
                                        <img src="" id="img3" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="imgUpload">
                                    <label class="imgUpload_btn">
                                        <input type="file" name="photo4" id="photo4" onChange="fileSelected(this, 4)" value="<{L('上传')}>"   />
                                        <img src="" id="img4" style="display:none;" width="100%" height="100%" />
                                    </label>
                                </div>
                            </li>
                            <li>
                                <div class="prompt">
                                    <p class="black9">112x112px</p>
                                    <p class="black9"><{L('限传')}>4<{L('张图')}></p>
                                </div>
                            </li>
                        </ul>
                        <div class="clear"></div>
                    </div>
                    <input type='hidden' name='data[order_id]' id='order_id' value='<{$order.order_id}>'>
                </div>
            </section>
            <footer>
                <div class="ord_tousu">
                    <p class="fl"><{L('评价后可获得')}><span class="maincl"><{$jifen}></span><{L('积分')}></p>
                    <input type="submit" value="<{L('提交评价')}>" id="comment_submit" class="fr pub_btn coment" />
                </div>
            </footer>
        </form>

        <script>
            $(document).ready(function () {
                $('.star_clink a').click(function () {
                    var val = $(this).attr('val');
                    $(this).parent().parent().find('input').val(val);
                    $(this).parent().parent().find('.star').css('width', val * 20 + '%');
                })


                
                $("#comment_form").ajaxForm({"target": "#comment_submit", "type": "post", "dataType": "json", "success": function (ret) {
                        if (ret.error == 0) {
                            layer.open({content: ret.message, time: 2});
                            setTimeout(function () {
                                window.location.href = "<{link ctl='order/detail' args=$order.order_id }>";
                            }, 2000);
                        } else {
                            layer.open({content: ret.message, time: 2});
                            return false;
                        }

                    }});
                
                $("#collect_btn").click(function(){
                    if($(this).attr('rel') == 1){
                        var url = "<{link ctl='shop/cancel' arg0=$order.shop_id}>";
                    }else{
                        var url = "<{link ctl='shop/collect' arg0=$order.shop_id}>";
                    }
                    $.post(url,{},function(data){
                        if(data.error >0){
                            layer.open({content:data.message,time:2});
                        }else{
                            layer.open({content:data.message,time:2});
                            setTimeout(function(){
                                window.location.reload(true);
                            },1000)
                        }
                    },'json')
                })

                goback();
             
                function goback() {
                    if(localStorage['pinjiatips']=='orderwell') {
                        $(".gobackIco").attr("href","<{link ctl='order:orderwell'}>");
                    }
                    if(localStorage['pinjiatips']=='work') {
                        $(".gobackIco").attr("href","<{link ctl='order:work' args=$order.order_id}>");
                    }
                    if(localStorage['pinjiatips']=='detail'){
                        $(".gobackIco").attr("href","<{link ctl='order:detail' args=$order.order_id}>");
                    }
                }
            })
        </script>
    </body>
</html>